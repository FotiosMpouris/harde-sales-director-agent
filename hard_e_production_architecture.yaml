# Hard-E Agent & Tool Configuration
# This is a public, illustrative representation of the production architecture.
# Actual implementation details, API keys, and proprietary logic are not included.

agents:
  triage_agent:
    model: gpt-4.1
    role: "router"
    description: >
      Primary routing agent that analyzes user intent and conversation history
      to hand off tasks to specialized agents. Does not execute tools directly—
      only routes via handoffs. Uses priority-based logic: ongoing processes,
      keyword detection, conversation history analysis, explicit requests.
    tools: []
    handoffs:
      - leap_interaction_agent
      - knowledge_agent
      - analysis_agent
      - web_search_agent
      - scripting_agent
      - new_clients_agent

  leap_interaction_agent:
    model: gpt-4.1
    role: "crm_operations"
    description: >
      Manages all Leap CRM interactions for existing customer and job data.
      Retrieves job stages, customer addresses, job notes, and comprehensive
      customer information. Updates job stages with optional workflow triggers.
      Supports @mention notifications via undocumented API with smart fallback.
    tools:
      - tool_get_job_stage_by_name_or_id
      - tool_update_job_stage_by_name
      - tool_fetch_leap_job_description
      - tool_fetch_leap_notes
      - tool_add_leap_note
      - tool_add_job_note_smart
      - tool_get_leap_customer_address
      - tool_get_comprehensive_info_by_client_name
      - tool_refine_with_xai_grok

  knowledge_agent:
    model: gpt-4.1
    role: "internal_knowledge"
    description: >
      Answers questions based on company training materials and project-specific
      knowledge bases stored in S3. Reads documents from multiple prefixes
      (training/, Yarmouth/, meeting_summaries/, price_book/) and synthesizes
      grounded answers. Supports streaming via SDK model composition.
    tools:
      - tool_get_training_answer
      - tool_refine_with_xai_grok
    streaming_enabled: true

  scripting_agent:
    model: gpt-4.1
    role: "video_script_generator"
    state_managed: true
    description: >
      Manages multi-turn, stateful generation of both standard proposal scripts
      and short primer video scripts. Uses ScriptDraftState to track job_id,
      client_name, project_type, focus_material, context flags, and completion
      status. Conversationally collects required details, fetches job context
      from Leap CRM, identifies script type (primer vs standard) from keywords,
      and maintains idempotency guards.
    state_object: "ScriptDraftState"
    tools:
      - tool_set_script_field
      - tool_fetch_leap_context
      - tool_generate_final_script
      - tool_generate_primer_script
      - tool_stream_back
      - tool_refine_with_xai_grok

  new_clients_agent:
    model: gpt-4.1
    role: "customer_creation"
    state_managed: true
    description: >
      Creates new customers and optional jobs in Leap CRM via natural language
      input (voice or text). Uses GPT-4.1-mini with function calling for
      LLM-powered field extraction. Handles speech artifacts (email normalization,
      state code mapping), supports synonym mapping, and allows flexible data
      entry with "skip" commands. Achieves 95%+ success rate for single-pass
      voice/text customer creation.
    state_object: "NewClientState"
    extraction_model: "gpt-4.1-mini"
    tools:
      - tool_set_client_field
      - tool_create_leap_customer
      - tool_create_leap_job
      - tool_get_client_summary
      - tool_reset_client_state
      - tool_refine_with_xai_grok

  analysis_agent:
    model: gpt-4.1
    role: "transcript_analyst"
    description: >
      Analyzes patterns across 90+ distilled historical transcripts stored in
      S3. Identifies common objections, typical script structures, frequently
      mentioned competitor products, and best practices from successful sales.
      Uses section_summary format JSONs for pattern recognition.
    tools:
      - tool_analyze_transcripts
      - tool_refine_with_xai_grok

  web_search_agent:
    model: gpt-4.1
    role: "external_information"
    description: >
      Retrieves current product information, warranties, and specifications
      via Perplexity API (sonar-pro model). Provides synthesized answers with
      citations rather than raw search results. Used for latest warranty terms,
      color options, technical specifications, and competitive comparisons.
    api: "Perplexity (sonar-pro)"
    tools:
      - tool_perform_web_search
      - tool_refine_with_xai_grok

  pricing_agent:
    role: "cost_calculation"
    type: "module"
    status: "developing"
    description: >
      Searches compiled pricing catalog (S3 JSONL) and calculates material/labor
      costs with area-based pricing. Not an SDK Agent—implemented as module with
      direct function calls. Supports token-based search with fuzzy fallback,
      basis extraction from descriptions, automatic unit conversions, and coverage
      inference. Currently operational but requires data quality improvements
      before full production deployment.
    tools:
      - tool_get_material_price
      - tool_calculate_material_cost
      - tool_price_for_area
      - tool_price_by_area_sqft

# Tool Definitions
tools:
  # CRM Tools (Leap Integration)
  tool_get_job_stage_by_name_or_id:
    description: "Get current stage of job by client name or job ID"
    implementation: "leap_agent.py"
    api: "Leap V3 + Undocumented Public API"

  tool_update_job_stage_by_name:
    description: "Change job stage, optionally trigger automation workflows"
    implementation: "leap_agent.py"
    api: "Undocumented Public API (RA Token)"
    
  tool_fetch_leap_job_description:
    description: "Retrieve job description text from Leap CRM"
    implementation: "leap_agent.py"
    api: "Leap V3 API"

  tool_fetch_leap_notes:
    description: "Get all notes for a specific job"
    implementation: "leap_agent.py"
    api: "Leap V3 API"

  tool_add_leap_note:
    description: "Add basic note to job (no notifications)"
    implementation: "leap_agent.py"
    api: "Leap V3 API"

  tool_add_job_note_smart:
    description: "Add note with @mention support via smart fallback"
    implementation: "leap_agent.py"
    api: "Undocumented Public API → V3 API fallback"
    note: "Transforms @mentions to @[u:USER_ID] format, RA Token required"

  tool_get_leap_customer_address:
    description: "Get customer address details"
    implementation: "leap_agent.py"
    api: "Leap V3 API"

  tool_get_comprehensive_info_by_client_name:
    description: "Get full customer and primary job details by name"
    implementation: "leap_agent.py"
    api: "Leap V3 API"

  # Knowledge Tools
  tool_get_training_answer:
    description: "Query company training materials and project knowledge"
    implementation: "mother_agent.py"
    data_sources:
      - "s3://hard-e-transcripts/training/"
      - "s3://hard-e-transcripts/Yarmouth/"
      - "s3://hard-e-transcripts/meeting_summaries/"
      - "s3://hard-e-transcripts/price_book/"
    synthesis_model: "gpt-4.1"

  # Script Generation Tools (Stateful)
  tool_set_script_field:
    description: "Set field in ScriptDraftState (job_id, client_name, etc.)"
    implementation: "chat_agent.py"
    stateful: true
    state_context: "ScriptDraftState"

  tool_fetch_leap_context:
    description: "Fetch job description and notes from Leap CRM"
    implementation: "chat_agent.py"
    stateful: true

  tool_generate_final_script:
    description: "Generate full proposal video script"
    implementation: "transcript_analyzer.py"
    uses_distilled_transcripts: true

  tool_generate_primer_script:
    description: "Generate short primer/intro script (1-2 minutes)"
    implementation: "transcript_analyzer.py"
    uses_distilled_transcripts: true

  tool_stream_back:
    description: "Return text for streaming display (internal use)"
    implementation: "chat_agent.py"

  tool_render_primer_video:
    description: "Render video and upload to Google Drive"
    implementation: "primer_cloudinary.py + drive_uploader.py"
    status: "operational"
    pipeline:
      - "Two-stage TTS (OpenAI → ElevenLabs)"
      - "Cloudinary video rendering"
      - "Google Drive upload with shareable link"

  # Customer Creation Tools (Stateful)
  tool_set_client_field:
    description: "Set field in NewClientState"
    implementation: "chat_agent.py"
    stateful: true
    state_context: "NewClientState"
    llm_extraction: "gpt-4.1-mini with function calling"

  tool_create_leap_customer:
    description: "Create customer in Leap CRM"
    implementation: "leap_agent.py"
    api: "Leap V3 API"
    min_required: "first_name or last_name + phone"

  tool_create_leap_job:
    description: "Create job for newly created customer"
    implementation: "leap_agent.py"
    api: "Leap V3 API"

  tool_get_client_summary:
    description: "Show current collected client information"
    implementation: "chat_agent.py"
    stateful: true

  tool_reset_client_state:
    description: "Clear client state to start over"
    implementation: "chat_agent.py"
    stateful: true

  # Pricing Tools
  tool_get_material_price:
    description: "Look up material or labor by name/SKU"
    implementation: "pricing_agent.py"
    data_source: "s3://hard-e-transcripts/price_book/compiled/catalog.jsonl"
    cache_ttl: "5 minutes"

  tool_calculate_material_cost:
    description: "Multiply quantity by unit price"
    implementation: "pricing_agent.py"

  tool_price_for_area:
    description: "Calculate cost from length × width dimensions"
    implementation: "pricing_agent.py"
    supports: "squares, sq_ft, lin_ft conversions"

  tool_price_by_area_sqft:
    description: "Calculate cost from total area (square feet)"
    implementation: "pricing_agent.py"
    supports: "coverage inference for wraps/rolls"

  # Analysis Tools
  tool_analyze_transcripts:
    description: "Analyze patterns across historical transcripts"
    implementation: "transcript_analyzer.py"
    data_source: "s3://hard-e-transcripts/distilled_transcripts/"
    count: "90 structured JSONs"

  # Web Search Tools
  tool_perform_web_search:
    description: "Search web via Perplexity for external information"
    implementation: "web_search_agent.py"
    api: "Perplexity (sonar-pro)"

  # Refinement Tool
  tool_refine_with_xai_grok:
    description: "Polish response text for consistent persona"
    implementation: "chat_agent.py"
    model: "grok-3-mini-beta"
    endpoint: "https://api.x.ai/v1/chat/completions"
    status: "configurable via ENABLE_GROK_REWRITE flag"

# Autonomous Workflows
autonomous_workflows:
  primer_video_pipeline:
    status: "operational"
    trigger: "Email to privatename@gmail.com with subject 'Please produce Primer Video'"
    daemon: "email_listener.py (60-second polling)"
    orchestrator: "workflow_automations.run_autonomous_primer_workflow()"
    steps:
      - "Fetch customer and job context from Leap"
      - "Generate personalized primer script"
      - "Generate two-stage TTS audio (OpenAI → ElevenLabs)"
      - "Upload audio to Cloudinary with unique asset ID"
      - "Build video transformation (music 30%, narration +8s)"
      - "Download rendered MP4"
      - "Upload to Google Drive with shareable link"
      - "Add job note in Leap with HTML link"
      - "15-minute delay for Drive processing"
      - "Send personalized client email with video link"
      - "Comprehensive cleanup (files + cloud assets)"
    total_time: "18-22 minutes"
    error_handling: "try/except/finally with automatic cleanup"

# Architecture Notes
architecture:
  type: "Hybrid (Manual Streaming + SDK Processing)"
  routing:
    simple_queries: "Manual streaming flow (real-time text, sub-500ms first token)"
    complex_workflows: "SDK-based processing (state management, multi-agent handoffs)"
  state_management:
    current: "st.session_state (in-memory, session-based)"
    planned_v3: "Redis (distributed, multi-worker support)"
  audio_pipeline:
    standard: "OpenAI TTS (tts-1, shimmer voice)"
    primer: "Two-stage (OpenAI TTS → ElevenLabs S2S)"
  deployment:
    server: "AWS EC2 t3.small (2 vCPU, 2 GiB RAM, 20 GiB EBS)"
    os: "Amazon Linux 2"
    framework: "Streamlit (current), React/FastAPI (planned v3.0)"
    web_server: "Nginx reverse proxy"
    security: "HTTPS (Let's Encrypt), HTTP Basic Auth"
    process_management: "systemd service (harde-streaming.service)"
    url: "https://streaming.harde.app (port 8504)"

# Planned Agents (Future Development)
planned_agents:
  image_analysis_agent:
    status: "planned"
    purpose: "Analyze job site photos for damage assessment and measurements"
    technology: "Multimodal LLM (GPT-4 Vision or equivalent)"
    
  sales_director_clone_agent:
    status: "planned"
    purpose: "Provide insights from sales meeting summaries"
    data_source: "s3://hard-e-transcripts/meeting_summaries/"
    
  hover_integration_agent:
    status: "planned"
    purpose: "Access 3D models and precise measurements from Hover platform"

# Data Sources
data_sources:
  leap_crm:
    type: "Live transactional data"
    auth_methods:
      - "V3 API (Bearer token)"
      - "Undocumented Public API (RA Token)"
    entities: "customers, jobs, notes, job_stages"
    
  s3_bucket:
    name: "hard-e-transcripts"
    region: "us-east-2"
    size: "~4 MB"
    structure:
      root: "4 raw transcripts (~3.8 MB)"
      training: "General sales training documents (~6 KB)"
      Yarmouth: "Project-specific knowledge"
      distilled_transcripts: "90 structured JSON summaries"
      meeting_summaries: "Planned: sales meeting notes"
      price_book: "raw/ and compiled/ pricing catalog"
      logs: "query_log.txt (all user queries, timestamped)"
      
  external_apis:
    openai: "GPT-4.1, GPT-4.1-mini, Whisper, TTS"
    xai: "Grok (grok-3-mini-beta)"
    elevenlabs: "Speech-to-Speech (eleven_multilingual_sts_v2)"
    perplexity: "sonar-pro"
    cloudinary: "Video rendering and CDN"
    google_drive: "Video delivery with service account"
    gmail: "IMAP monitoring for workflow triggers"

# Version Information
current_version:
  name: "Production (Streaming Architecture)"
  framework: "Streamlit"
  openai_agents_sdk: ">=0.0.17"
  deployment_date: "August 2025"
  
next_version:
  name: "v3.0 (Next-Generation)"
  framework: "React + FastAPI"
  status: "Planning/Early Development"
  key_features:
    - "Real-time voice via Retell/Vapi"
    - "Redis state management"
    - "Multi-user concurrent support"
    - "Horizontal scaling capability"
  target_url: "https://next.harde.app"

# Notes
notes: >
  This configuration represents the production Hard-E system as of December 2025.
  Actual implementation includes proprietary logic, API keys, and integration
  details not shown here. The autonomous primer video workflow is fully operational.
  The pricing system is developing (data quality improvements needed). The v3.0
  architecture rebuild is in planning/early development phase with parallel
  operation planned (no production disruption).
